{"version":3,"sources":["../../../src/app/controllers/StudentClassContoller.js"],"names":["StudentClassContoller","req","res","result","schemaEmail","body","success","status","json","object","send","clas","Class","findOne","where","id","id_class","include","model","User","as","errors","user","email","students","some","student","id_teacher","link","id_user","entry_date","Date","now","StudentClass","create","schemaCode","userId","code"],"mappings":"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","file":"StudentClassContoller.js","sourcesContent":["import User from '../models/User';\r\nimport Class from '../models/Class';\r\nimport StudentClass from '../models/StudentClass';\r\nimport validate from '../common/validate';\r\nimport schemaEmail from '../schemasValidation/StudentClass/linkByEmail';\r\nimport schemaCode from '../schemasValidation/StudentClass/linkByCode';\r\n\r\nclass StudentClassContoller {\r\n  async linkByEmail(req, res) {\r\n    const result = await validate(schemaEmail, req.body);\r\n\r\n    if (!result.success) return res.status(400).json(result.object).send();\r\n\r\n    const { object } = result;\r\n\r\n    const clas = await Class.findOne({\r\n      where: {\r\n        id: object.id_class,\r\n      },\r\n      include: [\r\n        {\r\n          model: User,\r\n          as: 'students',\r\n        },\r\n      ],\r\n    });\r\n    if (!clas)\r\n      return res\r\n        .status(404)\r\n        .json({ errors: { errors: ['Turma não encontrada'] } });\r\n\r\n    const user = await User.findOne({\r\n      where: {\r\n        email: object.email,\r\n      },\r\n    });\r\n    if (!user)\r\n      return res\r\n        .status(404)\r\n        .json({ errors: { errors: ['Usuário não encontrado'] } });\r\n\r\n    if (\r\n      clas.students.some((student) => student.id === user.id) ||\r\n      clas.id_teacher === user.id\r\n    )\r\n      return res.status(404).json({\r\n        errors: { errors: ['Usuário já vinculado a turma informada'] },\r\n      });\r\n\r\n    const link = {\r\n      id_class: clas.id,\r\n      id_user: user.id,\r\n      entry_date: Date.now(),\r\n    };\r\n\r\n    const { id, entry_date } = await StudentClass.create(link);\r\n\r\n    return res.json({\r\n      id,\r\n      entry_date,\r\n    });\r\n  }\r\n\r\n  async linkByCode(req, res) {\r\n    const result = await validate(schemaCode, req.body);\r\n\r\n    if (!result.success) return res.status(400).json(result.object).send();\r\n\r\n    const { object } = result;\r\n    const { userId } = req;\r\n\r\n    const clas = await Class.findOne({\r\n      where: {\r\n        code: object.code,\r\n      },\r\n      include: [\r\n        {\r\n          model: User,\r\n          as: 'students',\r\n        },\r\n      ],\r\n    });\r\n    if (!clas)\r\n      return res\r\n        .status(404)\r\n        .json({ errors: { errors: ['Turma não encontrado'] } });\r\n\r\n    if (\r\n      clas.students.some((student) => student.id === userId) ||\r\n      clas.id_teacher === userId\r\n    )\r\n      return res.status(404).json({\r\n        errors: { errors: ['Usuário já vinculado a turma informada'] },\r\n      });\r\n\r\n    const link = {\r\n      id_class: clas.id,\r\n      id_user: userId,\r\n      entry_date: Date.now(),\r\n    };\r\n\r\n    const { id, entry_date } = await StudentClass.create(link);\r\n\r\n    return res.json({\r\n      id,\r\n      entry_date,\r\n    });\r\n  }\r\n}\r\n\r\nexport default new StudentClassContoller();\r\n"]}